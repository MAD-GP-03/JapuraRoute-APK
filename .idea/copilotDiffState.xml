<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/japuraroutef/ui/MapScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/japuraroutef/ui/MapScreen.kt" />
              <option name="originalContent" value="package com.example.japuraroutef.ui&#10;&#10;import android.Manifest&#10;import android.util.Log&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.animation.AnimatedVisibility&#10;import androidx.compose.animation.slideInVertically&#10;import androidx.compose.animation.slideOutVertically&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.gestures.detectVerticalDragGestures&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Brush&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.input.pointer.pointerInput&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import coil.compose.AsyncImage&#10;import com.example.japuraroutef.R&#10;import com.example.japuraroutef.model.PlaceCategory&#10;import com.example.japuraroutef.model.PlaceResponseDto&#10;import com.example.japuraroutef.viewmodel.PlaceViewModel&#10;import com.mapbox.geojson.Point&#10;import com.mapbox.geojson.LineString&#10;import com.mapbox.maps.CameraBoundsOptions&#10;import com.mapbox.maps.CameraOptions&#10;import com.mapbox.maps.extension.compose.MapboxMap&#10;import com.mapbox.maps.extension.compose.animation.viewport.rememberMapViewportState&#10;import com.mapbox.maps.extension.compose.style.MapStyle&#10;import com.mapbox.maps.extension.compose.MapEffect&#10;import com.mapbox.maps.plugin.annotation.generated.PointAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.generated.PolylineAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.generated.CircleAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.annotations&#10;import com.mapbox.maps.plugin.annotation.generated.createPointAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.createPolylineAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.createCircleAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.PolylineAnnotationManager&#10;import com.mapbox.maps.plugin.locationcomponent.location&#10;import com.mapbox.maps.MapView&#10;import com.mapbox.maps.plugin.animation.MapAnimationOptions&#10;import com.mapbox.maps.plugin.animation.flyTo&#10;import kotlinx.coroutines.launch&#10;import retrofit2.Retrofit&#10;import retrofit2.converter.gson.GsonConverterFactory&#10;import retrofit2.http.GET&#10;import retrofit2.http.Path&#10;import retrofit2.http.Query&#10;&#10;data class DirectionsResponse(&#10;    val routes: List&lt;Route&gt;&#10;)&#10;&#10;data class Route(&#10;    val geometry: String,&#10;    val distance: Double,&#10;    val duration: Double&#10;)&#10;&#10;interface MapboxDirectionsService {&#10;    @GET(&quot;directions/v5/mapbox/walking/{coordinates}&quot;)&#10;    suspend fun getDirections(&#10;        @Path(&quot;coordinates&quot;) coordinates: String,&#10;        @Query(&quot;geometries&quot;) geometries: String = &quot;polyline6&quot;,&#10;        @Query(&quot;overview&quot;) overview: String = &quot;full&quot;,&#10;        @Query(&quot;access_token&quot;) accessToken: String&#10;    ): DirectionsResponse&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun MapScreen(&#10;    onNavigateBack: () -&gt; Unit,&#10;    viewModel: PlaceViewModel = viewModel()&#10;) {&#10;    val context = LocalContext.current&#10;    val placesUiState by viewModel.placesUiState.collectAsState()&#10;&#10;    var selectedPlace by remember { mutableStateOf&lt;PlaceResponseDto?&gt;(null) }&#10;    var selectedCategory by remember { mutableStateOf(PlaceCategory.ALL) }&#10;    var searchQuery by remember { mutableStateOf(&quot;&quot;) }&#10;    var currentRoute by remember { mutableStateOf&lt;Route?&gt;(null) }&#10;    var currentLocation by remember { mutableStateOf&lt;Point?&gt;(null) }&#10;    var mapLoadError by remember { mutableStateOf&lt;String?&gt;(null) }&#10;    var mapViewInstance by remember { mutableStateOf&lt;MapView?&gt;(null) }&#10;    var polylineManager by remember { mutableStateOf&lt;PolylineAnnotationManager?&gt;(null) }&#10;&#10;&#10;    val coroutineScope = rememberCoroutineScope()&#10;    val accessToken = context.getString(R.string.mapbox_access_token)&#10;&#10;    // Initialize Retrofit for Mapbox Directions API&#10;    val directionsService = remember {&#10;        Retrofit.Builder()&#10;            .baseUrl(&quot;https://api.mapbox.com/&quot;)&#10;            .addConverterFactory(GsonConverterFactory.create())&#10;            .build()&#10;            .create(MapboxDirectionsService::class.java)&#10;    }&#10;&#10;    // Location permission launcher&#10;    val locationPermissionRequest = rememberLauncherForActivityResult(&#10;        ActivityResultContracts.RequestMultiplePermissions()&#10;    ) { permissions -&gt;&#10;        when {&#10;            permissions.getOrDefault(Manifest.permission.ACCESS_FINE_LOCATION, false) -&gt; {&#10;                // Precise location access granted&#10;            }&#10;            permissions.getOrDefault(Manifest.permission.ACCESS_COARSE_LOCATION, false) -&gt; {&#10;                // Only approximate location access granted&#10;            }&#10;        }&#10;    }&#10;&#10;    LaunchedEffect(Unit) {&#10;        // Load places when screen opens&#10;        Log.d(&quot;MapScreen&quot;, &quot;Calling viewModel.loadPlaces()&quot;)&#10;        viewModel.loadPlaces()&#10;&#10;        // Request location permissions&#10;        locationPermissionRequest.launch(arrayOf(&#10;            Manifest.permission.ACCESS_FINE_LOCATION,&#10;            Manifest.permission.ACCESS_COARSE_LOCATION&#10;        ))&#10;    }&#10;&#10;    // Log places state changes&#10;    LaunchedEffect(placesUiState.places) {&#10;        Log.d(&quot;MapScreen&quot;, &quot;Places state changed: ${placesUiState.places.size} places, isLoading: ${placesUiState.isLoading}, error: ${placesUiState.error}&quot;)&#10;        placesUiState.places.forEachIndexed { index, place -&gt;&#10;            Log.d(&quot;MapScreen&quot;, &quot;Place $index: ${place.name}, lat: ${place.latitude}, lng: ${place.longitude}&quot;)&#10;        }&#10;    }&#10;&#10;    // Cleanup when leaving screen&#10;    DisposableEffect(Unit) {&#10;        onDispose {&#10;            // Clear any resources if needed&#10;            polylineManager?.deleteAll()&#10;            polylineManager = null&#10;            currentRoute = null&#10;        }&#10;    }&#10;&#10;    // Filter places based on category and search&#10;    val filteredPlaces = remember(placesUiState.places, selectedCategory, searchQuery) {&#10;        val filtered = placesUiState.places.filter { place -&gt;&#10;            val matchesCategory = selectedCategory == PlaceCategory.ALL ||&#10;                place.tags.any { it.equals(selectedCategory.tag, ignoreCase = true) }&#10;&#10;            val matchesSearch = searchQuery.isEmpty() ||&#10;                place.name.contains(searchQuery, ignoreCase = true) ||&#10;                place.description?.contains(searchQuery, ignoreCase = true) == true&#10;&#10;            matchesCategory &amp;&amp; matchesSearch&#10;        }&#10;        Log.d(&quot;MapScreen&quot;, &quot;Filtered places: ${filtered.size} out of ${placesUiState.places.size} (category: ${selectedCategory.displayName}, search: '$searchQuery')&quot;)&#10;        filtered&#10;    }&#10;&#10;    // Camera bounds for the map&#10;    val cameraBoundsOptions = CameraBoundsOptions.Builder()&#10;        .minZoom(15.0)&#10;        .maxZoom(22.0)&#10;        .build()&#10;&#10;    Box(modifier = Modifier.fillMaxSize()) {&#10;        // Show error if map failed to load, otherwise show map&#10;        if (mapLoadError != null) {&#10;            Box(&#10;                modifier = Modifier.fillMaxSize(),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Column(&#10;                    horizontalAlignment = Alignment.CenterHorizontally,&#10;                    verticalArrangement = Arrangement.spacedBy(16.dp),&#10;                    modifier = Modifier.padding(24.dp)&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.ErrorOutline,&#10;                        contentDescription = &quot;Error&quot;,&#10;                        tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark,&#10;                        modifier = Modifier.size(64.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;Map failed to load&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = mapLoadError ?: &quot;Please check your internet connection and Mapbox token&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                    Button(onClick = onNavigateBack) {&#10;                        Text(&quot;Go Back&quot;)&#10;                    }&#10;                }&#10;            }&#10;        } else {&#10;            MapboxMap(&#10;                Modifier.fillMaxSize(),&#10;                compass = {&#10;                    Compass( alignment = Alignment.CenterEnd )&#10;                },&#10;                mapViewportState = rememberMapViewportState {&#10;                    setCameraOptions {&#10;                        zoom(17.5)&#10;                        center(Point.fromLngLat(80.04168, 6.82314))&#10;                        pitch(60.0)&#10;                        bearing(-17.6)&#10;                    }&#10;                },&#10;                style = {&#10;                    MapStyle(style = &quot;mapbox://styles/nuwankonara/cmifk82fz001y01qw6bsdhv86&quot;)&#10;                }&#10;            ) {&#10;            MapEffect(filteredPlaces, selectedPlace, currentRoute) { mapView -&gt;&#10;                mapView.mapboxMap.setBounds(cameraBoundsOptions)&#10;&#10;                mapViewInstance = mapView&#10;&#10;                Log.d(&quot;MapScreen&quot;, &quot;Filtered places count: ${filteredPlaces.size}&quot;)&#10;&#10;                // Add markers for filtered places using Circle Annotations for guaranteed visibility&#10;                val annotationApi = mapView.annotations&#10;&#10;                // Use circle annotations for markers&#10;                val circleAnnotationManager = annotationApi.createCircleAnnotationManager()&#10;                circleAnnotationManager.deleteAll()&#10;&#10;                // Use point annotations for text labels&#10;                val pointAnnotationManager = annotationApi.createPointAnnotationManager()&#10;                pointAnnotationManager.deleteAll()&#10;&#10;                // Create or reuse polyline annotation manager for routes - single instance&#10;                if (polylineManager == null) {&#10;                    polylineManager = annotationApi.createPolylineAnnotationManager()&#10;                }&#10;                polylineManager?.deleteAll()&#10;&#10;                // Create a map to track annotations and their places&#10;                val annotationPlaceMap = mutableMapOf&lt;String, PlaceResponseDto&gt;()&#10;&#10;                filteredPlaces.forEach { place -&gt;&#10;                    if (place.latitude != null &amp;&amp; place.longitude != null) {&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Adding marker for: ${place.name} at ${place.latitude}, ${place.longitude}&quot;)&#10;&#10;                        try {&#10;                            // Create a visible circle marker&#10;                            val circleAnnotationOptions = CircleAnnotationOptions()&#10;                                .withPoint(Point.fromLngLat(place.longitude, place.latitude))&#10;                                .withCircleRadius(8.0)&#10;                                .withCircleColor(&quot;#D1BCFF&quot;)&#10;                                .withCircleStrokeWidth(2.0)&#10;                                .withCircleStrokeColor(&quot;#FFFFFF&quot;)&#10;&#10;                            val annotation = circleAnnotationManager.create(circleAnnotationOptions)&#10;&#10;                            // Store place reference using annotation ID&#10;                            annotationPlaceMap[annotation.id] = place&#10;&#10;                            // Add text label for the place name&#10;                            val pointAnnotationOptions = PointAnnotationOptions()&#10;                                .withPoint(Point.fromLngLat(place.longitude, place.latitude))&#10;                                .withTextField(place.name)&#10;                                .withTextColor(&quot;#FFFFFF&quot;)&#10;                                .withTextSize(12.0)&#10;                                .withTextHaloColor(&quot;#000000&quot;)&#10;                                .withTextHaloWidth(1.0)&#10;                                .withTextOffset(listOf(0.0, -1.5))&#10;&#10;                            pointAnnotationManager.create(pointAnnotationOptions)&#10;&#10;                            Log.d(&quot;MapScreen&quot;, &quot;Successfully added marker with ID: ${annotation.id}&quot;)&#10;                        } catch (e: Exception) {&#10;                            Log.e(&quot;MapScreen&quot;, &quot;Error adding marker for ${place.name}: ${e.message}&quot;)&#10;                        }&#10;                    } else {&#10;                        Log.w(&quot;MapScreen&quot;, &quot;Place ${place.name} has no coordinates (lat: ${place.latitude}, lng: ${place.longitude})&quot;)&#10;                    }&#10;                }&#10;&#10;                // Add click listener for markers&#10;                circleAnnotationManager.addClickListener { annotation -&gt;&#10;                    Log.d(&quot;MapScreen&quot;, &quot;Marker clicked with ID: ${annotation.id}&quot;)&#10;                    val clickedPlace = annotationPlaceMap[annotation.id]&#10;                    if (clickedPlace != null) {&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Found place: ${clickedPlace.name}&quot;)&#10;                        selectedPlace = clickedPlace&#10;                    } else {&#10;                        Log.w(&quot;MapScreen&quot;, &quot;No place found for annotation ID: ${annotation.id}&quot;)&#10;                    }&#10;                    true&#10;                }&#10;&#10;                Log.d(&quot;MapScreen&quot;, &quot;Total markers added: ${circleAnnotationManager.annotations.size}&quot;)&#10;                Log.d(&quot;MapScreen&quot;, &quot;Annotation place map size: ${annotationPlaceMap.size}&quot;)&#10;&#10;                // Enable location component and get current location&#10;                mapView.location.updateSettings {&#10;                    enabled = true&#10;                    pulsingEnabled = true&#10;                }&#10;&#10;                // Get current location safely&#10;                try {&#10;                    mapView.location.addOnIndicatorPositionChangedListener { point -&gt;&#10;                        currentLocation = point&#10;                    }&#10;                } catch (e: Exception) {&#10;                    Log.e(&quot;MapScreen&quot;, &quot;Error setting up location listener: ${e.message}&quot;)&#10;                }&#10;&#10;                // Draw route if available&#10;                currentRoute?.let { route -&gt;&#10;                    try {&#10;                        val points = LineString.fromPolyline(route.geometry, 6).coordinates()&#10;&#10;                        val polylineAnnotationOptions = PolylineAnnotationOptions()&#10;                            .withPoints(points)&#10;                            .withLineColor(&quot;#D1BCFF&quot;)&#10;                            .withLineWidth(5.0)&#10;                        polylineManager?.create(polylineAnnotationOptions)&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Route drawn successfully&quot;)&#10;                    } catch (e: Exception) {&#10;                        Log.e(&quot;MapScreen&quot;, &quot;Error drawing route: ${e.message}&quot;, e)&#10;                    }&#10;                } ?: run {&#10;                    Log.d(&quot;MapScreen&quot;, &quot;No route to draw - route cleared&quot;)&#10;                }&#10;            }&#10;        }&#10;        }&#10;&#10;        // Top gradient overlay&#10;        Box(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .height(120.dp)&#10;                .background(&#10;                    Brush.verticalGradient(&#10;                        colors = listOf(&#10;                            com.example.japuraroutef.ui.theme.BackgroundDark.copy(alpha = 0.9f),&#10;                            Color.Transparent&#10;                        )&#10;                    )&#10;                )&#10;        )&#10;&#10;        // UI Overlay&#10;        Column(&#10;            modifier = Modifier.fillMaxSize()&#10;        ) {&#10;            // Top Section - Search and Filters&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .statusBarsPadding()&#10;                    .padding(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                // Search Bar&#10;                Surface(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp),&#10;                    shape = RoundedCornerShape(28.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 4.dp&#10;                ) {&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxSize()&#10;                            .padding(horizontal = 8.dp),&#10;                        verticalAlignment = Alignment.CenterVertically,&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        IconButton(onClick = onNavigateBack) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Menu,&#10;                                contentDescription = &quot;Menu&quot;,&#10;                                tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                            )&#10;                        }&#10;&#10;                        androidx.compose.foundation.text.BasicTextField(&#10;                            value = searchQuery,&#10;                            onValueChange = { searchQuery = it },&#10;                            modifier = Modifier.weight(1f),&#10;                            textStyle = MaterialTheme.typography.bodyLarge.copy(&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                            ),&#10;                            singleLine = true,&#10;                            decorationBox = { innerTextField -&gt;&#10;                                Box {&#10;                                    if (searchQuery.isEmpty()) {&#10;                                        Text(&#10;                                            &quot;Search University Places&quot;,&#10;                                            style = MaterialTheme.typography.bodyLarge,&#10;                                            color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                        )&#10;                                    }&#10;                                    innerTextField()&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Category Filter Chips&#10;                LazyRow(&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp),&#10;                    contentPadding = PaddingValues(horizontal = 4.dp)&#10;                ) {&#10;                    items(PlaceCategory.entries.filter { it != PlaceCategory.ALL }) { category -&gt;&#10;                        CategoryChipMap(&#10;                            category = category,&#10;                            isSelected = selectedCategory == category,&#10;                            onClick = {&#10;                                selectedCategory = if (selectedCategory == category) {&#10;                                    PlaceCategory.ALL&#10;                                } else {&#10;                                    category&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.weight(1f))&#10;&#10;            // Location Control Buttons&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(end = 16.dp, bottom = if (selectedPlace != null || filteredPlaces.isNotEmpty()) 16.dp else 80.dp)&#10;                    .navigationBarsPadding(),&#10;                horizontalAlignment = Alignment.End,&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                // My Location Button&#10;                Surface(&#10;                    onClick = {&#10;                        currentLocation?.let { location -&gt;&#10;                            mapViewInstance?.mapboxMap?.flyTo(&#10;                                CameraOptions.Builder()&#10;                                    .center(location)&#10;                                    .zoom(17.5)&#10;                                    .pitch(60.0)&#10;                                    .bearing(-17.6)&#10;                                    .build(),&#10;                                MapAnimationOptions.mapAnimationOptions {&#10;                                    duration(1200)&#10;                                }&#10;                            )&#10;                        }&#10;                    },&#10;                    modifier = Modifier.size(56.dp),&#10;                    shape = RoundedCornerShape(16.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 8.dp,&#10;                    border = androidx.compose.foundation.BorderStroke(&#10;                        1.dp,&#10;                        com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.2f)&#10;                    )&#10;                ) {&#10;                    Box(contentAlignment = Alignment.Center) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.MyLocation,&#10;                            contentDescription = &quot;My Location&quot;,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Faculty Default Location Button&#10;                Surface(&#10;                    onClick = {&#10;                        mapViewInstance?.mapboxMap?.flyTo(&#10;                            CameraOptions.Builder()&#10;                                .center(Point.fromLngLat(80.04168, 6.82314))&#10;                                .zoom(17.5)&#10;                                .pitch(60.0)&#10;                                .bearing(-17.6)&#10;                                .build(),&#10;                            MapAnimationOptions.mapAnimationOptions {&#10;                                duration(1200)&#10;                            }&#10;                        )&#10;                    },&#10;                    modifier = Modifier.size(56.dp),&#10;                    shape = RoundedCornerShape(16.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 8.dp,&#10;                    border = androidx.compose.foundation.BorderStroke(&#10;                        1.dp,&#10;                        com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.2f)&#10;                    )&#10;                ) {&#10;                    Box(contentAlignment = Alignment.Center) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.School,&#10;                            contentDescription = &quot;Faculty Location&quot;,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;&#10;&#10;            // Bottom Sheet with Place Details or Simple Place List&#10;            if (selectedPlace != null) {&#10;                PlaceDetailBottomSheet(&#10;                    place = selectedPlace!!,&#10;                    onClose = {&#10;                        selectedPlace = null&#10;                        // Don't clear route - keep it visible after closing&#10;                    },&#10;                    onGetDirections = {&#10;                        coroutineScope.launch {&#10;                            try {&#10;                                // Clear previous route first and wait for UI to update&#10;                                currentRoute = null&#10;                                kotlinx.coroutines.delay(100) // Small delay to ensure MapEffect clears the old route&#10;&#10;                                val origin = currentLocation ?: Point.fromLngLat(80.04168, 6.82314)&#10;                                val destination = Point.fromLngLat(&#10;                                    selectedPlace!!.longitude ?: 0.0,&#10;                                    selectedPlace!!.latitude ?: 0.0&#10;                                )&#10;                                val coords = &quot;${origin.longitude()},${origin.latitude()};${destination.longitude()},${destination.latitude()}&quot;&#10;                                val response = directionsService.getDirections(coords, accessToken = accessToken)&#10;                                if (response.routes.isNotEmpty()) {&#10;                                    currentRoute = response.routes[0]&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                e.printStackTrace()&#10;                            }&#10;                        }&#10;                    }&#10;                )&#10;            } else if (filteredPlaces.isNotEmpty()) {&#10;                // Simple fixed place list (not collapsible)&#10;                SimplePlaceList(&#10;                    places = filteredPlaces.take(5),&#10;                    onPlaceClick = { place -&gt;&#10;                        // Don't clear route when selecting a place - only clear when clicking Get Directions&#10;                        selectedPlace = place&#10;                    }&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CategoryChipMap(&#10;    category: PlaceCategory,&#10;    isSelected: Boolean,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    val icon = when (category) {&#10;        PlaceCategory.STUDY -&gt; Icons.Default.School&#10;        PlaceCategory.FOOD -&gt; Icons.Default.Restaurant&#10;        PlaceCategory.ADMIN -&gt; Icons.Default.Business&#10;        PlaceCategory.HEALTH -&gt; Icons.Default.LocalHospital&#10;        PlaceCategory.SPORTS -&gt; Icons.Default.FitnessCenter&#10;        else -&gt; Icons.Default.Place&#10;    }&#10;&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(8.dp),&#10;        color = if (isSelected)&#10;            com.example.japuraroutef.ui.theme.SecondaryContainerDark&#10;        else&#10;            com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark,&#10;        border = androidx.compose.foundation.BorderStroke(&#10;            1.dp,&#10;            if (isSelected) Color.Transparent else com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.3f)&#10;        ),&#10;        modifier = Modifier.height(32.dp)&#10;    ) {&#10;        Row(&#10;            modifier = Modifier.padding(horizontal = 16.dp, vertical = 6.dp),&#10;            horizontalArrangement = Arrangement.spacedBy(8.dp),&#10;            verticalAlignment = Alignment.CenterVertically&#10;        ) {&#10;            Icon(&#10;                imageVector = icon,&#10;                contentDescription = null,&#10;                modifier = Modifier.size(18.dp),&#10;                tint = if (isSelected)&#10;                    com.example.japuraroutef.ui.theme.OnSecondaryContainerDark&#10;                else&#10;                    com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;            )&#10;            Text(&#10;                text = category.displayName,&#10;                style = MaterialTheme.typography.labelMedium,&#10;                fontWeight = FontWeight.Medium,&#10;                color = if (isSelected)&#10;                    com.example.japuraroutef.ui.theme.OnSecondaryContainerDark&#10;                else&#10;                    com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun SimplePlaceList(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding(),&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(top = 16.dp, bottom = 16.dp)&#10;        ) {&#10;            // Header&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(horizontal = 20.dp, vertical = 8.dp),&#10;                horizontalArrangement = Arrangement.SpaceBetween,&#10;                verticalAlignment = Alignment.CenterVertically&#10;            ) {&#10;                Column {&#10;                    Text(&#10;                        text = &quot;Nearby Places&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        fontWeight = FontWeight.Medium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = &quot;${places.size} places found&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.height(8.dp))&#10;&#10;            // Horizontal scrolling place cards&#10;            LazyRow(&#10;                modifier = Modifier.fillMaxWidth(),&#10;                horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                contentPadding = PaddingValues(horizontal = 16.dp)&#10;            ) {&#10;                items(places) { place -&gt;&#10;                    CompactPlaceCard(&#10;                        place = place,&#10;                        onClick = { onPlaceClick(place) }&#10;                    )&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.height(8.dp))&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CollapsiblePlaceList(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    isExpanded: Boolean,&#10;    onToggleExpand: () -&gt; Unit,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding(),&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(top = 16.dp, bottom = 16.dp)&#10;        ) {&#10;            // Header with toggle button&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(horizontal = 20.dp, vertical = 8.dp),&#10;                horizontalArrangement = Arrangement.SpaceBetween,&#10;                verticalAlignment = Alignment.CenterVertically&#10;            ) {&#10;                Column {&#10;                    Text(&#10;                        text = &quot;Nearby Places&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        fontWeight = FontWeight.Medium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = &quot;${places.size} places found&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                }&#10;&#10;                IconButton(&#10;                    onClick = onToggleExpand,&#10;                    modifier = Modifier.size(40.dp)&#10;                ) {&#10;                    Icon(&#10;                        imageVector = if (isExpanded) Icons.Default.ExpandMore else Icons.Default.ExpandLess,&#10;                        contentDescription = if (isExpanded) &quot;Hide&quot; else &quot;Show&quot;,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;&#10;            // Expandable list&#10;            AnimatedVisibility(&#10;                visible = isExpanded,&#10;                enter = slideInVertically(initialOffsetY = { -it }),&#10;                exit = slideOutVertically(targetOffsetY = { -it })&#10;            ) {&#10;                LazyColumn(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .heightIn(max = 400.dp)&#10;                        .padding(horizontal = 16.dp),&#10;                    verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    items(places) { place -&gt;&#10;                        PlacePreviewCard(&#10;                            place = place,&#10;                            onClick = { onPlaceClick(place) }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;            // Show compact preview when collapsed&#10;            if (!isExpanded &amp;&amp; places.isNotEmpty()) {&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;                LazyRow(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                    contentPadding = PaddingValues(horizontal = 16.dp)&#10;                ) {&#10;                    items(places.take(3)) { place -&gt;&#10;                        CompactPlaceCard(&#10;                            place = place,&#10;                            onClick = { onPlaceClick(place) }&#10;                        )&#10;                    }&#10;                }&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CompactPlaceCard(&#10;    place: PlaceResponseDto,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(12.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;        modifier = Modifier.width(140.dp)&#10;    ) {&#10;        Column(&#10;            modifier = Modifier.padding(12.dp),&#10;            verticalArrangement = Arrangement.spacedBy(8.dp)&#10;        ) {&#10;            if (place.images.isNotEmpty()) {&#10;                AsyncImage(&#10;                    model = place.images.first(),&#10;                    contentDescription = place.name,&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(80.dp)&#10;                        .clip(RoundedCornerShape(8.dp)),&#10;                    contentScale = ContentScale.Crop&#10;                )&#10;            } else {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(80.dp)&#10;                        .clip(RoundedCornerShape(8.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Place,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary,&#10;                        modifier = Modifier.size(32.dp)&#10;                    )&#10;                }&#10;            }&#10;&#10;            Text(&#10;                text = place.name,&#10;                style = MaterialTheme.typography.labelLarge,&#10;                fontWeight = FontWeight.Medium,&#10;                color = com.example.japuraroutef.ui.theme.OnSurfaceDark,&#10;                maxLines = 2,&#10;                overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis&#10;            )&#10;&#10;            if (place.rating != null) {&#10;                Row(&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Star,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary,&#10;                        modifier = Modifier.size(14.dp)&#10;                    )&#10;                    Text(&#10;                        text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                        style = MaterialTheme.typography.labelSmall,&#10;                        color = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlaceListPreview(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    var offsetY by remember { mutableStateOf(0f) }&#10;    val maxDragDistance = 300f&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding()&#10;            .offset { androidx.compose.ui.unit.IntOffset(0, offsetY.toInt()) }&#10;            .pointerInput(Unit) {&#10;                detectVerticalDragGestures(&#10;                    onDragEnd = {&#10;                        // Snap back to position&#10;                        offsetY = 0f&#10;                    },&#10;                    onVerticalDrag = { _, dragAmount -&gt;&#10;                        val newOffset = offsetY + dragAmount&#10;                        // Only allow dragging down&#10;                        if (newOffset &gt;= 0 &amp;&amp; newOffset &lt;= maxDragDistance) {&#10;                            offsetY = newOffset&#10;                        }&#10;                    }&#10;                )&#10;            },&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .heightIn(max = 400.dp)&#10;                .padding(top = 20.dp, bottom = 20.dp)&#10;        ) {&#10;            // Drag Handle&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(bottom = 16.dp),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .width(48.dp)&#10;                        .height(6.dp)&#10;                        .clip(RoundedCornerShape(3.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.4f))&#10;                )&#10;            }&#10;&#10;            LazyColumn(&#10;                modifier = Modifier.fillMaxWidth(),&#10;                verticalArrangement = Arrangement.spacedBy(8.dp),&#10;                contentPadding = PaddingValues(start = 16.dp, end = 16.dp, bottom = 16.dp)&#10;            ) {&#10;                items(places) { place -&gt;&#10;                    PlacePreviewCard(place = place, onClick = { onPlaceClick(place) })&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlacePreviewCard(&#10;    place: PlaceResponseDto,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(16.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;        modifier = Modifier.fillMaxWidth()&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp),&#10;            horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;        ) {&#10;            if (place.images.isNotEmpty()) {&#10;                AsyncImage(&#10;                    model = place.images.first(),&#10;                    contentDescription = place.name,&#10;                    modifier = Modifier&#10;                        .size(60.dp)&#10;                        .clip(RoundedCornerShape(12.dp)),&#10;                    contentScale = ContentScale.Crop&#10;                )&#10;            } else {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .size(60.dp)&#10;                        .clip(RoundedCornerShape(12.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Place,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;&#10;            Column(&#10;                modifier = Modifier.weight(1f),&#10;                verticalArrangement = Arrangement.spacedBy(4.dp)&#10;            ) {&#10;                Text(&#10;                    text = place.name,&#10;                    style = MaterialTheme.typography.titleSmall,&#10;                    fontWeight = FontWeight.Medium,&#10;                    color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                )&#10;                Text(&#10;                    text = place.shortDescription ?: place.location ?: &quot;&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                )&#10;                if (place.rating != null) {&#10;                    Row(&#10;                        horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.Star,&#10;                            contentDescription = null,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary,&#10;                            modifier = Modifier.size(14.dp)&#10;                        )&#10;                        Text(&#10;                            text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                            style = MaterialTheme.typography.labelSmall,&#10;                            color = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlaceDetailBottomSheet(&#10;    place: PlaceResponseDto,&#10;    onClose: () -&gt; Unit,&#10;    onGetDirections: () -&gt; Unit&#10;) {&#10;    var offsetY by remember { mutableStateOf(0f) }&#10;    val maxDragDistance = 400f&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding()&#10;            .offset { androidx.compose.ui.unit.IntOffset(0, offsetY.toInt()) }&#10;            .pointerInput(Unit) {&#10;                detectVerticalDragGestures(&#10;                    onDragEnd = {&#10;                        // If dragged down more than 200dp, close it&#10;                        if (offsetY &gt; 200f) {&#10;                            onClose()&#10;                        } else {&#10;                            // Snap back to position&#10;                            offsetY = 0f&#10;                        }&#10;                    },&#10;                    onVerticalDrag = { _, dragAmount -&gt;&#10;                        val newOffset = offsetY + dragAmount&#10;                        // Only allow dragging down&#10;                        if (newOffset &gt;= 0 &amp;&amp; newOffset &lt;= maxDragDistance) {&#10;                            offsetY = newOffset&#10;                        }&#10;                    }&#10;                )&#10;            },&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.98f),&#10;        shadowElevation = 24.dp&#10;    ) {&#10;        LazyColumn(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .heightIn(max = 600.dp)&#10;        ) {&#10;            item {&#10;                // Drag Handle&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(vertical = 20.dp),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .width(48.dp)&#10;                            .height(6.dp)&#10;                            .clip(RoundedCornerShape(3.dp))&#10;                            .background(com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.4f))&#10;                    )&#10;                }&#10;            }&#10;&#10;            item {&#10;                Column(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 24.dp),&#10;                    verticalArrangement = Arrangement.spacedBy(16.dp)&#10;                ) {&#10;                    // Header with title, bookmark, and close button&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.SpaceBetween,&#10;                        verticalAlignment = Alignment.Top&#10;                    ) {&#10;                        Column(&#10;                            modifier = Modifier.weight(1f),&#10;                            verticalArrangement = Arrangement.spacedBy(4.dp)&#10;                        ) {&#10;                            Text(&#10;                                text = place.name,&#10;                                style = MaterialTheme.typography.headlineSmall,&#10;                                fontWeight = FontWeight.Normal,&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                            )&#10;                            Text(&#10;                                text = &quot;${place.location ?: &quot;Campus&quot;}  Open until 10 PM&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium,&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                            )&#10;                            if (place.rating != null) {&#10;                                Row(&#10;                                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                                    verticalAlignment = Alignment.CenterVertically&#10;                                ) {&#10;                                    Text(&#10;                                        text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                                        style = MaterialTheme.typography.labelMedium,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        color = com.example.japuraroutef.ui.theme.Primary&#10;                                    )&#10;                                    repeat(5) { index -&gt;&#10;                                        Icon(&#10;                                            imageVector = if (index &lt; place.rating.toInt()) Icons.Default.Star else Icons.Default.StarBorder,&#10;                                            contentDescription = null,&#10;                                            tint = com.example.japuraroutef.ui.theme.Primary,&#10;                                            modifier = Modifier.size(16.dp)&#10;                                        )&#10;                                    }&#10;                                    Text(&#10;                                        text = &quot;(${place.ratingCount} reviews)&quot;,&#10;                                        style = MaterialTheme.typography.labelSmall,&#10;                                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;&#10;                        Row(&#10;                            horizontalArrangement = Arrangement.spacedBy(4.dp)&#10;                        ) {&#10;                            IconButton(&#10;                                onClick = { /* TODO: Bookmark */ },&#10;                                modifier = Modifier.size(48.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Default.BookmarkBorder,&#10;                                    contentDescription = &quot;Bookmark&quot;,&#10;                                    tint = com.example.japuraroutef.ui.theme.Primary&#10;                                )&#10;                            }&#10;                            IconButton(&#10;                                onClick = onClose,&#10;                                modifier = Modifier.size(48.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Default.Close,&#10;                                    contentDescription = &quot;Close&quot;,&#10;                                    tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    // Images Gallery&#10;                    if (place.images.isNotEmpty()) {&#10;                        LazyRow(&#10;                            horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                            contentPadding = PaddingValues(vertical = 8.dp)&#10;                        ) {&#10;                            items(place.images) { imageUrl -&gt;&#10;                                AsyncImage(&#10;                                    model = imageUrl,&#10;                                    contentDescription = place.name,&#10;                                    modifier = Modifier&#10;                                        .height(112.dp)&#10;                                        .width(160.dp)&#10;                                        .clip(RoundedCornerShape(12.dp))&#10;                                        .border(&#10;                                            1.dp,&#10;                                            com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.1f),&#10;                                            RoundedCornerShape(12.dp)&#10;                                        ),&#10;                                    contentScale = ContentScale.Crop&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    // Action Buttons&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Button(&#10;                            onClick = onGetDirections,&#10;                            modifier = Modifier&#10;                                .weight(1f)&#10;                                .height(48.dp),&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            colors = ButtonDefaults.buttonColors(&#10;                                containerColor = com.example.japuraroutef.ui.theme.Primary,&#10;                                contentColor = com.example.japuraroutef.ui.theme.OnPrimaryContainerLight&#10;                            )&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Directions,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.size(20.dp)&#10;                            )&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&#10;                                &quot;Get Directions&quot;,&#10;                                style = MaterialTheme.typography.labelLarge,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                        }&#10;&#10;                        OutlinedButton(&#10;                            onClick = { /* TODO: Call */ },&#10;                            modifier = Modifier&#10;                                .weight(1f)&#10;                                .height(48.dp),&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            colors = ButtonDefaults.outlinedButtonColors(&#10;                                contentColor = com.example.japuraroutef.ui.theme.Primary&#10;                            ),&#10;                            border = androidx.compose.foundation.BorderStroke(&#10;                                1.dp,&#10;                                com.example.japuraroutef.ui.theme.OutlineDark&#10;                            )&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Call,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.size(20.dp)&#10;                            )&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&#10;                                &quot;Call&quot;,&#10;                                style = MaterialTheme.typography.labelLarge,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(24.dp))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.example.japuraroutef.ui&#10;&#10;import android.Manifest&#10;import android.util.Log&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.animation.AnimatedVisibility&#10;import androidx.compose.animation.slideInVertically&#10;import androidx.compose.animation.slideOutVertically&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.gestures.detectVerticalDragGestures&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Brush&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.input.pointer.pointerInput&#10;import androidx.compose.ui.layout.ContentScale&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.unit.dp&#10;import androidx.lifecycle.viewmodel.compose.viewModel&#10;import coil.compose.AsyncImage&#10;import com.example.japuraroutef.R&#10;import com.example.japuraroutef.model.PlaceCategory&#10;import com.example.japuraroutef.model.PlaceResponseDto&#10;import com.example.japuraroutef.viewmodel.PlaceViewModel&#10;import com.mapbox.geojson.Point&#10;import com.mapbox.geojson.LineString&#10;import com.mapbox.maps.CameraBoundsOptions&#10;import com.mapbox.maps.CameraOptions&#10;import com.mapbox.maps.extension.compose.MapboxMap&#10;import com.mapbox.maps.extension.compose.animation.viewport.rememberMapViewportState&#10;import com.mapbox.maps.extension.compose.style.MapStyle&#10;import com.mapbox.maps.extension.compose.MapEffect&#10;import com.mapbox.maps.plugin.annotation.generated.PointAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.generated.PolylineAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.generated.CircleAnnotationOptions&#10;import com.mapbox.maps.plugin.annotation.annotations&#10;import com.mapbox.maps.plugin.annotation.generated.createPointAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.createPolylineAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.createCircleAnnotationManager&#10;import com.mapbox.maps.plugin.annotation.generated.PolylineAnnotationManager&#10;import com.mapbox.maps.plugin.locationcomponent.location&#10;import com.mapbox.maps.MapView&#10;import com.mapbox.maps.plugin.animation.MapAnimationOptions&#10;import com.mapbox.maps.plugin.animation.flyTo&#10;import kotlinx.coroutines.launch&#10;import retrofit2.Retrofit&#10;import retrofit2.converter.gson.GsonConverterFactory&#10;import retrofit2.http.GET&#10;import retrofit2.http.Path&#10;import retrofit2.http.Query&#10;&#10;data class DirectionsResponse(&#10;    val routes: List&lt;Route&gt;&#10;)&#10;&#10;data class Route(&#10;    val geometry: String,&#10;    val distance: Double,&#10;    val duration: Double&#10;)&#10;&#10;interface MapboxDirectionsService {&#10;    @GET(&quot;directions/v5/mapbox/walking/{coordinates}&quot;)&#10;    suspend fun getDirections(&#10;        @Path(&quot;coordinates&quot;) coordinates: String,&#10;        @Query(&quot;geometries&quot;) geometries: String = &quot;polyline6&quot;,&#10;        @Query(&quot;overview&quot;) overview: String = &quot;full&quot;,&#10;        @Query(&quot;access_token&quot;) accessToken: String&#10;    ): DirectionsResponse&#10;}&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun MapScreen(&#10;    onNavigateBack: () -&gt; Unit,&#10;    viewModel: PlaceViewModel = viewModel()&#10;) {&#10;    val context = LocalContext.current&#10;    val placesUiState by viewModel.placesUiState.collectAsState()&#10;&#10;    var selectedPlace by remember { mutableStateOf&lt;PlaceResponseDto?&gt;(null) }&#10;    var selectedCategory by remember { mutableStateOf(PlaceCategory.ALL) }&#10;    var searchQuery by remember { mutableStateOf(&quot;&quot;) }&#10;    var currentRoute by remember { mutableStateOf&lt;Route?&gt;(null) }&#10;    var currentLocation by remember { mutableStateOf&lt;Point?&gt;(null) }&#10;    var mapLoadError by remember { mutableStateOf&lt;String?&gt;(null) }&#10;    var mapViewInstance by remember { mutableStateOf&lt;MapView?&gt;(null) }&#10;    var polylineManager by remember { mutableStateOf&lt;PolylineAnnotationManager?&gt;(null) }&#10;&#10;&#10;    val coroutineScope = rememberCoroutineScope()&#10;    val accessToken = context.getString(R.string.mapbox_access_token)&#10;&#10;    // Initialize Retrofit for Mapbox Directions API&#10;    val directionsService = remember {&#10;        Retrofit.Builder()&#10;            .baseUrl(&quot;https://api.mapbox.com/&quot;)&#10;            .addConverterFactory(GsonConverterFactory.create())&#10;            .build()&#10;            .create(MapboxDirectionsService::class.java)&#10;    }&#10;&#10;    // Location permission launcher&#10;    val locationPermissionRequest = rememberLauncherForActivityResult(&#10;        ActivityResultContracts.RequestMultiplePermissions()&#10;    ) { permissions -&gt;&#10;        when {&#10;            permissions.getOrDefault(Manifest.permission.ACCESS_FINE_LOCATION, false) -&gt; {&#10;                // Precise location access granted&#10;            }&#10;            permissions.getOrDefault(Manifest.permission.ACCESS_COARSE_LOCATION, false) -&gt; {&#10;                // Only approximate location access granted&#10;            }&#10;        }&#10;    }&#10;&#10;    LaunchedEffect(Unit) {&#10;        // Load places when screen opens&#10;        Log.d(&quot;MapScreen&quot;, &quot;Calling viewModel.loadPlaces()&quot;)&#10;        viewModel.loadPlaces()&#10;&#10;        // Request location permissions&#10;        locationPermissionRequest.launch(arrayOf(&#10;            Manifest.permission.ACCESS_FINE_LOCATION,&#10;            Manifest.permission.ACCESS_COARSE_LOCATION&#10;        ))&#10;    }&#10;&#10;    // Log places state changes&#10;    LaunchedEffect(placesUiState.places) {&#10;        Log.d(&quot;MapScreen&quot;, &quot;Places state changed: ${placesUiState.places.size} places, isLoading: ${placesUiState.isLoading}, error: ${placesUiState.error}&quot;)&#10;        placesUiState.places.forEachIndexed { index, place -&gt;&#10;            Log.d(&quot;MapScreen&quot;, &quot;Place $index: ${place.name}, lat: ${place.latitude}, lng: ${place.longitude}&quot;)&#10;        }&#10;    }&#10;&#10;    // Cleanup when leaving screen&#10;    DisposableEffect(Unit) {&#10;        onDispose {&#10;            // Clear any resources if needed&#10;            polylineManager?.deleteAll()&#10;            polylineManager = null&#10;            currentRoute = null&#10;        }&#10;    }&#10;&#10;    // Filter places based on category and search&#10;    val filteredPlaces = remember(placesUiState.places, selectedCategory, searchQuery) {&#10;        val filtered = placesUiState.places.filter { place -&gt;&#10;            val matchesCategory = selectedCategory == PlaceCategory.ALL ||&#10;                place.tags.any { it.equals(selectedCategory.tag, ignoreCase = true) }&#10;&#10;            val matchesSearch = searchQuery.isEmpty() ||&#10;                place.name.contains(searchQuery, ignoreCase = true) ||&#10;                place.description?.contains(searchQuery, ignoreCase = true) == true&#10;&#10;            matchesCategory &amp;&amp; matchesSearch&#10;        }&#10;        Log.d(&quot;MapScreen&quot;, &quot;Filtered places: ${filtered.size} out of ${placesUiState.places.size} (category: ${selectedCategory.displayName}, search: '$searchQuery')&quot;)&#10;        filtered&#10;    }&#10;&#10;    // Camera bounds for the map&#10;    val cameraBoundsOptions = CameraBoundsOptions.Builder()&#10;        .minZoom(15.0)&#10;        .maxZoom(22.0)&#10;        .build()&#10;&#10;    Box(modifier = Modifier.fillMaxSize()) {&#10;        // Show error if map failed to load, otherwise show map&#10;        if (mapLoadError != null) {&#10;            Box(&#10;                modifier = Modifier.fillMaxSize(),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Column(&#10;                    horizontalAlignment = Alignment.CenterHorizontally,&#10;                    verticalArrangement = Arrangement.spacedBy(16.dp),&#10;                    modifier = Modifier.padding(24.dp)&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.ErrorOutline,&#10;                        contentDescription = &quot;Error&quot;,&#10;                        tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark,&#10;                        modifier = Modifier.size(64.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;Map failed to load&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = mapLoadError ?: &quot;Please check your internet connection and Mapbox token&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                    Button(onClick = onNavigateBack) {&#10;                        Text(&quot;Go Back&quot;)&#10;                    }&#10;                }&#10;            }&#10;        } else {&#10;            MapboxMap(&#10;                Modifier.fillMaxSize(),&#10;                compass = {&#10;                    Compass( alignment = Alignment.CenterEnd )&#10;                },&#10;                mapViewportState = rememberMapViewportState {&#10;                    setCameraOptions {&#10;                        zoom(17.5)&#10;                        center(Point.fromLngLat(80.04168, 6.82314))&#10;                        pitch(60.0)&#10;                        bearing(-17.6)&#10;                    }&#10;                },&#10;                style = {&#10;                    MapStyle(style = &quot;mapbox://styles/nuwankonara/cmifk82fz001y01qw6bsdhv86&quot;)&#10;                }&#10;            ) {&#10;            MapEffect(filteredPlaces, selectedPlace, currentRoute) { mapView -&gt;&#10;                mapView.mapboxMap.setBounds(cameraBoundsOptions)&#10;&#10;                mapViewInstance = mapView&#10;&#10;                Log.d(&quot;MapScreen&quot;, &quot;Filtered places count: ${filteredPlaces.size}&quot;)&#10;&#10;                // Add markers for filtered places using Circle Annotations for guaranteed visibility&#10;                val annotationApi = mapView.annotations&#10;&#10;                // Use circle annotations for markers&#10;                val circleAnnotationManager = annotationApi.createCircleAnnotationManager()&#10;                circleAnnotationManager.deleteAll()&#10;&#10;                // Use point annotations for text labels&#10;                val pointAnnotationManager = annotationApi.createPointAnnotationManager()&#10;                pointAnnotationManager.deleteAll()&#10;&#10;                // Create or reuse polyline annotation manager for routes - single instance&#10;                if (polylineManager == null) {&#10;                    polylineManager = annotationApi.createPolylineAnnotationManager()&#10;                }&#10;                polylineManager?.deleteAll()&#10;&#10;                // Create a map to track annotations and their places&#10;                val annotationPlaceMap = mutableMapOf&lt;String, PlaceResponseDto&gt;()&#10;&#10;                filteredPlaces.forEach { place -&gt;&#10;                    if (place.latitude != null &amp;&amp; place.longitude != null) {&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Adding marker for: ${place.name} at ${place.latitude}, ${place.longitude}&quot;)&#10;&#10;                        try {&#10;                            // Create a visible circle marker&#10;                            val circleAnnotationOptions = CircleAnnotationOptions()&#10;                                .withPoint(Point.fromLngLat(place.longitude, place.latitude))&#10;                                .withCircleRadius(8.0)&#10;                                .withCircleColor(&quot;#D1BCFF&quot;)&#10;                                .withCircleStrokeWidth(2.0)&#10;                                .withCircleStrokeColor(&quot;#FFFFFF&quot;)&#10;&#10;                            val annotation = circleAnnotationManager.create(circleAnnotationOptions)&#10;&#10;                            // Store place reference using annotation ID&#10;                            annotationPlaceMap[annotation.id] = place&#10;&#10;                            // Add text label for the place name&#10;                            val pointAnnotationOptions = PointAnnotationOptions()&#10;                                .withPoint(Point.fromLngLat(place.longitude, place.latitude))&#10;                                .withTextField(place.name)&#10;                                .withTextColor(&quot;#FFFFFF&quot;)&#10;                                .withTextSize(12.0)&#10;                                .withTextHaloColor(&quot;#000000&quot;)&#10;                                .withTextHaloWidth(1.0)&#10;                                .withTextOffset(listOf(0.0, -1.5))&#10;&#10;                            pointAnnotationManager.create(pointAnnotationOptions)&#10;&#10;                            Log.d(&quot;MapScreen&quot;, &quot;Successfully added marker with ID: ${annotation.id}&quot;)&#10;                        } catch (e: Exception) {&#10;                            Log.e(&quot;MapScreen&quot;, &quot;Error adding marker for ${place.name}: ${e.message}&quot;)&#10;                        }&#10;                    } else {&#10;                        Log.w(&quot;MapScreen&quot;, &quot;Place ${place.name} has no coordinates (lat: ${place.latitude}, lng: ${place.longitude})&quot;)&#10;                    }&#10;                }&#10;&#10;                // Add click listener for markers&#10;                circleAnnotationManager.addClickListener { annotation -&gt;&#10;                    Log.d(&quot;MapScreen&quot;, &quot;Marker clicked with ID: ${annotation.id}&quot;)&#10;                    val clickedPlace = annotationPlaceMap[annotation.id]&#10;                    if (clickedPlace != null) {&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Found place: ${clickedPlace.name}&quot;)&#10;                        selectedPlace = clickedPlace&#10;                    } else {&#10;                        Log.w(&quot;MapScreen&quot;, &quot;No place found for annotation ID: ${annotation.id}&quot;)&#10;                    }&#10;                    true&#10;                }&#10;&#10;                Log.d(&quot;MapScreen&quot;, &quot;Total markers added: ${circleAnnotationManager.annotations.size}&quot;)&#10;                Log.d(&quot;MapScreen&quot;, &quot;Annotation place map size: ${annotationPlaceMap.size}&quot;)&#10;&#10;                // Enable location component and get current location&#10;                mapView.location.updateSettings {&#10;                    enabled = true&#10;                    pulsingEnabled = true&#10;                }&#10;&#10;                // Get current location safely&#10;                try {&#10;                    mapView.location.addOnIndicatorPositionChangedListener { point -&gt;&#10;                        currentLocation = point&#10;                    }&#10;                } catch (e: Exception) {&#10;                    Log.e(&quot;MapScreen&quot;, &quot;Error setting up location listener: ${e.message}&quot;)&#10;                }&#10;&#10;                // Draw route if available&#10;                currentRoute?.let { route -&gt;&#10;                    try {&#10;                        val points = LineString.fromPolyline(route.geometry, 6).coordinates()&#10;&#10;                        val polylineAnnotationOptions = PolylineAnnotationOptions()&#10;                            .withPoints(points)&#10;                            .withLineColor(&quot;#1E88E5&quot;)  // Darker blue for better visibility&#10;                            .withLineWidth(6.0)  // Slightly thicker for better visibility&#10;                        polylineManager?.create(polylineAnnotationOptions)&#10;                        Log.d(&quot;MapScreen&quot;, &quot;Route drawn successfully&quot;)&#10;                    } catch (e: Exception) {&#10;                        Log.e(&quot;MapScreen&quot;, &quot;Error drawing route: ${e.message}&quot;, e)&#10;                    }&#10;                } ?: run {&#10;                    Log.d(&quot;MapScreen&quot;, &quot;No route to draw - route cleared&quot;)&#10;                }&#10;            }&#10;        }&#10;        }&#10;&#10;        // Top gradient overlay&#10;        Box(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .height(120.dp)&#10;                .background(&#10;                    Brush.verticalGradient(&#10;                        colors = listOf(&#10;                            com.example.japuraroutef.ui.theme.BackgroundDark.copy(alpha = 0.9f),&#10;                            Color.Transparent&#10;                        )&#10;                    )&#10;                )&#10;        )&#10;&#10;        // UI Overlay&#10;        Column(&#10;            modifier = Modifier.fillMaxSize()&#10;        ) {&#10;            // Top Section - Search and Filters&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .statusBarsPadding()&#10;                    .padding(16.dp),&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                // Search Bar&#10;                Surface(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp),&#10;                    shape = RoundedCornerShape(28.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 4.dp&#10;                ) {&#10;                    Row(&#10;                        modifier = Modifier&#10;                            .fillMaxSize()&#10;                            .padding(horizontal = 8.dp),&#10;                        verticalAlignment = Alignment.CenterVertically,&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        IconButton(onClick = onNavigateBack) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Menu,&#10;                                contentDescription = &quot;Menu&quot;,&#10;                                tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                            )&#10;                        }&#10;&#10;                        androidx.compose.foundation.text.BasicTextField(&#10;                            value = searchQuery,&#10;                            onValueChange = { searchQuery = it },&#10;                            modifier = Modifier.weight(1f),&#10;                            textStyle = MaterialTheme.typography.bodyLarge.copy(&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                            ),&#10;                            singleLine = true,&#10;                            decorationBox = { innerTextField -&gt;&#10;                                Box {&#10;                                    if (searchQuery.isEmpty()) {&#10;                                        Text(&#10;                                            &quot;Search University Places&quot;,&#10;                                            style = MaterialTheme.typography.bodyLarge,&#10;                                            color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                        )&#10;                                    }&#10;                                    innerTextField()&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Category Filter Chips&#10;                LazyRow(&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp),&#10;                    contentPadding = PaddingValues(horizontal = 4.dp)&#10;                ) {&#10;                    items(PlaceCategory.entries.filter { it != PlaceCategory.ALL }) { category -&gt;&#10;                        CategoryChipMap(&#10;                            category = category,&#10;                            isSelected = selectedCategory == category,&#10;                            onClick = {&#10;                                selectedCategory = if (selectedCategory == category) {&#10;                                    PlaceCategory.ALL&#10;                                } else {&#10;                                    category&#10;                                }&#10;                            }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.weight(1f))&#10;&#10;            // Location Control Buttons&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(end = 16.dp, bottom = if (selectedPlace != null || filteredPlaces.isNotEmpty()) 16.dp else 80.dp)&#10;                    .navigationBarsPadding(),&#10;                horizontalAlignment = Alignment.End,&#10;                verticalArrangement = Arrangement.spacedBy(12.dp)&#10;            ) {&#10;                // My Location Button&#10;                Surface(&#10;                    onClick = {&#10;                        currentLocation?.let { location -&gt;&#10;                            mapViewInstance?.mapboxMap?.flyTo(&#10;                                CameraOptions.Builder()&#10;                                    .center(location)&#10;                                    .zoom(17.5)&#10;                                    .pitch(60.0)&#10;                                    .bearing(-17.6)&#10;                                    .build(),&#10;                                MapAnimationOptions.mapAnimationOptions {&#10;                                    duration(1200)&#10;                                }&#10;                            )&#10;                        }&#10;                    },&#10;                    modifier = Modifier.size(56.dp),&#10;                    shape = RoundedCornerShape(16.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 8.dp,&#10;                    border = androidx.compose.foundation.BorderStroke(&#10;                        1.dp,&#10;                        com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.2f)&#10;                    )&#10;                ) {&#10;                    Box(contentAlignment = Alignment.Center) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.MyLocation,&#10;                            contentDescription = &quot;My Location&quot;,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;&#10;                // Faculty Default Location Button&#10;                Surface(&#10;                    onClick = {&#10;                        mapViewInstance?.mapboxMap?.flyTo(&#10;                            CameraOptions.Builder()&#10;                                .center(Point.fromLngLat(80.04168, 6.82314))&#10;                                .zoom(17.5)&#10;                                .pitch(60.0)&#10;                                .bearing(-17.6)&#10;                                .build(),&#10;                            MapAnimationOptions.mapAnimationOptions {&#10;                                duration(1200)&#10;                            }&#10;                        )&#10;                    },&#10;                    modifier = Modifier.size(56.dp),&#10;                    shape = RoundedCornerShape(16.dp),&#10;                    color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;                    shadowElevation = 8.dp,&#10;                    border = androidx.compose.foundation.BorderStroke(&#10;                        1.dp,&#10;                        com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.2f)&#10;                    )&#10;                ) {&#10;                    Box(contentAlignment = Alignment.Center) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.School,&#10;                            contentDescription = &quot;Faculty Location&quot;,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;&#10;&#10;            // Bottom Sheet with Place Details or Simple Place List&#10;            if (selectedPlace != null) {&#10;                PlaceDetailBottomSheet(&#10;                    place = selectedPlace!!,&#10;                    onClose = {&#10;                        selectedPlace = null&#10;                        // Don't clear route - keep it visible after closing&#10;                    },&#10;                    onGetDirections = {&#10;                        coroutineScope.launch {&#10;                            try {&#10;                                // Clear previous route first and wait for UI to update&#10;                                currentRoute = null&#10;                                kotlinx.coroutines.delay(100) // Small delay to ensure MapEffect clears the old route&#10;&#10;                                val origin = currentLocation ?: Point.fromLngLat(80.04168, 6.82314)&#10;                                val destination = Point.fromLngLat(&#10;                                    selectedPlace!!.longitude ?: 0.0,&#10;                                    selectedPlace!!.latitude ?: 0.0&#10;                                )&#10;                                val coords = &quot;${origin.longitude()},${origin.latitude()};${destination.longitude()},${destination.latitude()}&quot;&#10;                                val response = directionsService.getDirections(coords, accessToken = accessToken)&#10;                                if (response.routes.isNotEmpty()) {&#10;                                    currentRoute = response.routes[0]&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                e.printStackTrace()&#10;                            }&#10;                        }&#10;                    }&#10;                )&#10;            } else if (filteredPlaces.isNotEmpty()) {&#10;                // Simple fixed place list (not collapsible)&#10;                SimplePlaceList(&#10;                    places = filteredPlaces.take(5),&#10;                    onPlaceClick = { place -&gt;&#10;                        // Don't clear route when selecting a place - only clear when clicking Get Directions&#10;                        selectedPlace = place&#10;                    }&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CategoryChipMap(&#10;    category: PlaceCategory,&#10;    isSelected: Boolean,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    val icon = when (category) {&#10;        PlaceCategory.STUDY -&gt; Icons.Default.School&#10;        PlaceCategory.FOOD -&gt; Icons.Default.Restaurant&#10;        PlaceCategory.ADMIN -&gt; Icons.Default.Business&#10;        PlaceCategory.HEALTH -&gt; Icons.Default.LocalHospital&#10;        PlaceCategory.SPORTS -&gt; Icons.Default.FitnessCenter&#10;        else -&gt; Icons.Default.Place&#10;    }&#10;&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(8.dp),&#10;        color = if (isSelected)&#10;            com.example.japuraroutef.ui.theme.SecondaryContainerDark&#10;        else&#10;            com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark,&#10;        border = androidx.compose.foundation.BorderStroke(&#10;            1.dp,&#10;            if (isSelected) Color.Transparent else com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.3f)&#10;        ),&#10;        modifier = Modifier.height(32.dp)&#10;    ) {&#10;        Row(&#10;            modifier = Modifier.padding(horizontal = 16.dp, vertical = 6.dp),&#10;            horizontalArrangement = Arrangement.spacedBy(8.dp),&#10;            verticalAlignment = Alignment.CenterVertically&#10;        ) {&#10;            Icon(&#10;                imageVector = icon,&#10;                contentDescription = null,&#10;                modifier = Modifier.size(18.dp),&#10;                tint = if (isSelected)&#10;                    com.example.japuraroutef.ui.theme.OnSecondaryContainerDark&#10;                else&#10;                    com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;            )&#10;            Text(&#10;                text = category.displayName,&#10;                style = MaterialTheme.typography.labelMedium,&#10;                fontWeight = FontWeight.Medium,&#10;                color = if (isSelected)&#10;                    com.example.japuraroutef.ui.theme.OnSecondaryContainerDark&#10;                else&#10;                    com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;            )&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun SimplePlaceList(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding(),&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(top = 16.dp, bottom = 16.dp)&#10;        ) {&#10;            // Header&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(horizontal = 20.dp, vertical = 8.dp),&#10;                horizontalArrangement = Arrangement.SpaceBetween,&#10;                verticalAlignment = Alignment.CenterVertically&#10;            ) {&#10;                Column {&#10;                    Text(&#10;                        text = &quot;Nearby Places&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        fontWeight = FontWeight.Medium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = &quot;${places.size} places found&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.height(8.dp))&#10;&#10;            // Horizontal scrolling place cards&#10;            LazyRow(&#10;                modifier = Modifier.fillMaxWidth(),&#10;                horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                contentPadding = PaddingValues(horizontal = 16.dp)&#10;            ) {&#10;                items(places) { place -&gt;&#10;                    CompactPlaceCard(&#10;                        place = place,&#10;                        onClick = { onPlaceClick(place) }&#10;                    )&#10;                }&#10;            }&#10;&#10;            Spacer(modifier = Modifier.height(8.dp))&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CollapsiblePlaceList(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    isExpanded: Boolean,&#10;    onToggleExpand: () -&gt; Unit,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding(),&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(top = 16.dp, bottom = 16.dp)&#10;        ) {&#10;            // Header with toggle button&#10;            Row(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(horizontal = 20.dp, vertical = 8.dp),&#10;                horizontalArrangement = Arrangement.SpaceBetween,&#10;                verticalAlignment = Alignment.CenterVertically&#10;            ) {&#10;                Column {&#10;                    Text(&#10;                        text = &quot;Nearby Places&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        fontWeight = FontWeight.Medium,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                    )&#10;                    Text(&#10;                        text = &quot;${places.size} places found&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                    )&#10;                }&#10;&#10;                IconButton(&#10;                    onClick = onToggleExpand,&#10;                    modifier = Modifier.size(40.dp)&#10;                ) {&#10;                    Icon(&#10;                        imageVector = if (isExpanded) Icons.Default.ExpandMore else Icons.Default.ExpandLess,&#10;                        contentDescription = if (isExpanded) &quot;Hide&quot; else &quot;Show&quot;,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;&#10;            // Expandable list&#10;            AnimatedVisibility(&#10;                visible = isExpanded,&#10;                enter = slideInVertically(initialOffsetY = { -it }),&#10;                exit = slideOutVertically(targetOffsetY = { -it })&#10;            ) {&#10;                LazyColumn(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .heightIn(max = 400.dp)&#10;                        .padding(horizontal = 16.dp),&#10;                    verticalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    items(places) { place -&gt;&#10;                        PlacePreviewCard(&#10;                            place = place,&#10;                            onClick = { onPlaceClick(place) }&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;&#10;            // Show compact preview when collapsed&#10;            if (!isExpanded &amp;&amp; places.isNotEmpty()) {&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;                LazyRow(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                    contentPadding = PaddingValues(horizontal = 16.dp)&#10;                ) {&#10;                    items(places.take(3)) { place -&gt;&#10;                        CompactPlaceCard(&#10;                            place = place,&#10;                            onClick = { onPlaceClick(place) }&#10;                        )&#10;                    }&#10;                }&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun CompactPlaceCard(&#10;    place: PlaceResponseDto,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(12.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;        modifier = Modifier.width(140.dp)&#10;    ) {&#10;        Column(&#10;            modifier = Modifier.padding(12.dp),&#10;            verticalArrangement = Arrangement.spacedBy(8.dp)&#10;        ) {&#10;            if (place.images.isNotEmpty()) {&#10;                AsyncImage(&#10;                    model = place.images.first(),&#10;                    contentDescription = place.name,&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(80.dp)&#10;                        .clip(RoundedCornerShape(8.dp)),&#10;                    contentScale = ContentScale.Crop&#10;                )&#10;            } else {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(80.dp)&#10;                        .clip(RoundedCornerShape(8.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Place,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary,&#10;                        modifier = Modifier.size(32.dp)&#10;                    )&#10;                }&#10;            }&#10;&#10;            Text(&#10;                text = place.name,&#10;                style = MaterialTheme.typography.labelLarge,&#10;                fontWeight = FontWeight.Medium,&#10;                color = com.example.japuraroutef.ui.theme.OnSurfaceDark,&#10;                maxLines = 2,&#10;                overflow = androidx.compose.ui.text.style.TextOverflow.Ellipsis&#10;            )&#10;&#10;            if (place.rating != null) {&#10;                Row(&#10;                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Star,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary,&#10;                        modifier = Modifier.size(14.dp)&#10;                    )&#10;                    Text(&#10;                        text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                        style = MaterialTheme.typography.labelSmall,&#10;                        color = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlaceListPreview(&#10;    places: List&lt;PlaceResponseDto&gt;,&#10;    onPlaceClick: (PlaceResponseDto) -&gt; Unit&#10;) {&#10;    if (places.isEmpty()) return&#10;&#10;    var offsetY by remember { mutableStateOf(0f) }&#10;    val maxDragDistance = 300f&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding()&#10;            .offset { androidx.compose.ui.unit.IntOffset(0, offsetY.toInt()) }&#10;            .pointerInput(Unit) {&#10;                detectVerticalDragGestures(&#10;                    onDragEnd = {&#10;                        // Snap back to position&#10;                        offsetY = 0f&#10;                    },&#10;                    onVerticalDrag = { _, dragAmount -&gt;&#10;                        val newOffset = offsetY + dragAmount&#10;                        // Only allow dragging down&#10;                        if (newOffset &gt;= 0 &amp;&amp; newOffset &lt;= maxDragDistance) {&#10;                            offsetY = newOffset&#10;                        }&#10;                    }&#10;                )&#10;            },&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.95f),&#10;        shadowElevation = 16.dp&#10;    ) {&#10;        Column(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .heightIn(max = 400.dp)&#10;                .padding(top = 20.dp, bottom = 20.dp)&#10;        ) {&#10;            // Drag Handle&#10;            Box(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(bottom = 16.dp),&#10;                contentAlignment = Alignment.Center&#10;            ) {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .width(48.dp)&#10;                        .height(6.dp)&#10;                        .clip(RoundedCornerShape(3.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.4f))&#10;                )&#10;            }&#10;&#10;            LazyColumn(&#10;                modifier = Modifier.fillMaxWidth(),&#10;                verticalArrangement = Arrangement.spacedBy(8.dp),&#10;                contentPadding = PaddingValues(start = 16.dp, end = 16.dp, bottom = 16.dp)&#10;            ) {&#10;                items(places) { place -&gt;&#10;                    PlacePreviewCard(place = place, onClick = { onPlaceClick(place) })&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlacePreviewCard(&#10;    place: PlaceResponseDto,&#10;    onClick: () -&gt; Unit&#10;) {&#10;    Surface(&#10;        onClick = onClick,&#10;        shape = RoundedCornerShape(16.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerHighDark,&#10;        modifier = Modifier.fillMaxWidth()&#10;    ) {&#10;        Row(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(12.dp),&#10;            horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;        ) {&#10;            if (place.images.isNotEmpty()) {&#10;                AsyncImage(&#10;                    model = place.images.first(),&#10;                    contentDescription = place.name,&#10;                    modifier = Modifier&#10;                        .size(60.dp)&#10;                        .clip(RoundedCornerShape(12.dp)),&#10;                    contentScale = ContentScale.Crop&#10;                )&#10;            } else {&#10;                Box(&#10;                    modifier = Modifier&#10;                        .size(60.dp)&#10;                        .clip(RoundedCornerShape(12.dp))&#10;                        .background(com.example.japuraroutef.ui.theme.SurfaceContainerHighestDark),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Icon(&#10;                        imageVector = Icons.Default.Place,&#10;                        contentDescription = null,&#10;                        tint = com.example.japuraroutef.ui.theme.Primary&#10;                    )&#10;                }&#10;            }&#10;&#10;            Column(&#10;                modifier = Modifier.weight(1f),&#10;                verticalArrangement = Arrangement.spacedBy(4.dp)&#10;            ) {&#10;                Text(&#10;                    text = place.name,&#10;                    style = MaterialTheme.typography.titleSmall,&#10;                    fontWeight = FontWeight.Medium,&#10;                    color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                )&#10;                Text(&#10;                    text = place.shortDescription ?: place.location ?: &quot;&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                )&#10;                if (place.rating != null) {&#10;                    Row(&#10;                        horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                        verticalAlignment = Alignment.CenterVertically&#10;                    ) {&#10;                        Icon(&#10;                            imageVector = Icons.Default.Star,&#10;                            contentDescription = null,&#10;                            tint = com.example.japuraroutef.ui.theme.Primary,&#10;                            modifier = Modifier.size(14.dp)&#10;                        )&#10;                        Text(&#10;                            text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                            style = MaterialTheme.typography.labelSmall,&#10;                            color = com.example.japuraroutef.ui.theme.Primary&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;private fun PlaceDetailBottomSheet(&#10;    place: PlaceResponseDto,&#10;    onClose: () -&gt; Unit,&#10;    onGetDirections: () -&gt; Unit&#10;) {&#10;    var offsetY by remember { mutableStateOf(0f) }&#10;    val maxDragDistance = 400f&#10;&#10;    Surface(&#10;        modifier = Modifier&#10;            .fillMaxWidth()&#10;            .navigationBarsPadding()&#10;            .offset { androidx.compose.ui.unit.IntOffset(0, offsetY.toInt()) }&#10;            .pointerInput(Unit) {&#10;                detectVerticalDragGestures(&#10;                    onDragEnd = {&#10;                        // If dragged down more than 200dp, close it&#10;                        if (offsetY &gt; 200f) {&#10;                            onClose()&#10;                        } else {&#10;                            // Snap back to position&#10;                            offsetY = 0f&#10;                        }&#10;                    },&#10;                    onVerticalDrag = { _, dragAmount -&gt;&#10;                        val newOffset = offsetY + dragAmount&#10;                        // Only allow dragging down&#10;                        if (newOffset &gt;= 0 &amp;&amp; newOffset &lt;= maxDragDistance) {&#10;                            offsetY = newOffset&#10;                        }&#10;                    }&#10;                )&#10;            },&#10;        shape = RoundedCornerShape(topStart = 28.dp, topEnd = 28.dp),&#10;        color = com.example.japuraroutef.ui.theme.SurfaceContainerDark.copy(alpha = 0.98f),&#10;        shadowElevation = 24.dp&#10;    ) {&#10;        LazyColumn(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .heightIn(max = 600.dp)&#10;        ) {&#10;            item {&#10;                // Drag Handle&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(vertical = 20.dp),&#10;                    contentAlignment = Alignment.Center&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .width(48.dp)&#10;                            .height(6.dp)&#10;                            .clip(RoundedCornerShape(3.dp))&#10;                            .background(com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.4f))&#10;                    )&#10;                }&#10;            }&#10;&#10;            item {&#10;                Column(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 24.dp),&#10;                    verticalArrangement = Arrangement.spacedBy(16.dp)&#10;                ) {&#10;                    // Header with title, bookmark, and close button&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.SpaceBetween,&#10;                        verticalAlignment = Alignment.Top&#10;                    ) {&#10;                        Column(&#10;                            modifier = Modifier.weight(1f),&#10;                            verticalArrangement = Arrangement.spacedBy(4.dp)&#10;                        ) {&#10;                            Text(&#10;                                text = place.name,&#10;                                style = MaterialTheme.typography.headlineSmall,&#10;                                fontWeight = FontWeight.Normal,&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceDark&#10;                            )&#10;                            Text(&#10;                                text = &quot;${place.location ?: &quot;Campus&quot;}  Open until 10 PM&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium,&#10;                                color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                            )&#10;                            if (place.rating != null) {&#10;                                Row(&#10;                                    horizontalArrangement = Arrangement.spacedBy(4.dp),&#10;                                    verticalAlignment = Alignment.CenterVertically&#10;                                ) {&#10;                                    Text(&#10;                                        text = String.format(java.util.Locale.US, &quot;%.1f&quot;, place.rating),&#10;                                        style = MaterialTheme.typography.labelMedium,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        color = com.example.japuraroutef.ui.theme.Primary&#10;                                    )&#10;                                    repeat(5) { index -&gt;&#10;                                        Icon(&#10;                                            imageVector = if (index &lt; place.rating.toInt()) Icons.Default.Star else Icons.Default.StarBorder,&#10;                                            contentDescription = null,&#10;                                            tint = com.example.japuraroutef.ui.theme.Primary,&#10;                                            modifier = Modifier.size(16.dp)&#10;                                        )&#10;                                    }&#10;                                    Text(&#10;                                        text = &quot;(${place.ratingCount} reviews)&quot;,&#10;                                        style = MaterialTheme.typography.labelSmall,&#10;                                        color = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;&#10;                        Row(&#10;                            horizontalArrangement = Arrangement.spacedBy(4.dp)&#10;                        ) {&#10;                            IconButton(&#10;                                onClick = { /* TODO: Bookmark */ },&#10;                                modifier = Modifier.size(48.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Default.BookmarkBorder,&#10;                                    contentDescription = &quot;Bookmark&quot;,&#10;                                    tint = com.example.japuraroutef.ui.theme.Primary&#10;                                )&#10;                            }&#10;                            IconButton(&#10;                                onClick = onClose,&#10;                                modifier = Modifier.size(48.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Default.Close,&#10;                                    contentDescription = &quot;Close&quot;,&#10;                                    tint = com.example.japuraroutef.ui.theme.OnSurfaceVariantDark&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    // Images Gallery&#10;                    if (place.images.isNotEmpty()) {&#10;                        LazyRow(&#10;                            horizontalArrangement = Arrangement.spacedBy(12.dp),&#10;                            contentPadding = PaddingValues(vertical = 8.dp)&#10;                        ) {&#10;                            items(place.images) { imageUrl -&gt;&#10;                                AsyncImage(&#10;                                    model = imageUrl,&#10;                                    contentDescription = place.name,&#10;                                    modifier = Modifier&#10;                                        .height(112.dp)&#10;                                        .width(160.dp)&#10;                                        .clip(RoundedCornerShape(12.dp))&#10;                                        .border(&#10;                                            1.dp,&#10;                                            com.example.japuraroutef.ui.theme.OutlineDark.copy(alpha = 0.1f),&#10;                                            RoundedCornerShape(12.dp)&#10;                                        ),&#10;                                    contentScale = ContentScale.Crop&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    // Action Buttons&#10;                    Row(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;                    ) {&#10;                        Button(&#10;                            onClick = onGetDirections,&#10;                            modifier = Modifier&#10;                                .weight(1f)&#10;                                .height(48.dp),&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            colors = ButtonDefaults.buttonColors(&#10;                                containerColor = com.example.japuraroutef.ui.theme.Primary,&#10;                                contentColor = com.example.japuraroutef.ui.theme.OnPrimaryContainerLight&#10;                            )&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Directions,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.size(20.dp)&#10;                            )&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&#10;                                &quot;Get Directions&quot;,&#10;                                style = MaterialTheme.typography.labelLarge,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                        }&#10;&#10;                        OutlinedButton(&#10;                            onClick = { /* TODO: Call */ },&#10;                            modifier = Modifier&#10;                                .weight(1f)&#10;                                .height(48.dp),&#10;                            shape = RoundedCornerShape(24.dp),&#10;                            colors = ButtonDefaults.outlinedButtonColors(&#10;                                contentColor = com.example.japuraroutef.ui.theme.Primary&#10;                            ),&#10;                            border = androidx.compose.foundation.BorderStroke(&#10;                                1.dp,&#10;                                com.example.japuraroutef.ui.theme.OutlineDark&#10;                            )&#10;                        ) {&#10;                            Icon(&#10;                                imageVector = Icons.Default.Call,&#10;                                contentDescription = null,&#10;                                modifier = Modifier.size(20.dp)&#10;                            )&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&#10;                                &quot;Call&quot;,&#10;                                style = MaterialTheme.typography.labelLarge,&#10;                                fontWeight = FontWeight.Bold&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Spacer(modifier = Modifier.height(24.dp))&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>